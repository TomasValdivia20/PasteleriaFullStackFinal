# ===================================================================
# CONFIGURACION DE PRODUCCION - RAILWAY + SUPABASE FREE TIER
# ===================================================================
# üî¥ OPTIMIZADO PARA: Supabase Free Tier (20 conexiones max)
# Este perfil se activa con SPRING_PROFILES_ACTIVE=production en Railway

# ===================================================================
# DATABASE CONNECTION - SESSION POOLER (PORT 5432)
# ===================================================================
# üî¥ CAMBIO CR√çTICO: Transaction Pooler (6543) ‚Üí Session Pooler (5432)
# RAZ√ìN: Transaction Pooler tiene l√≠mite muy bajo (~15 conexiones Free Tier)
# Session Pooler permite hasta 60+ conexiones y mejor gesti√≥n de timeouts
# Par√°metros JDBC:
# - sslmode=require: Forzar SSL
# - idle_in_transaction_session_timeout=30s: Auto-cerrar conexiones idle en transacciones
# - connectTimeout=10: Timeout de conexi√≥n inicial (10 segundos)
spring.datasource.url=jdbc:postgresql://aws-1-sa-east-1.pooler.supabase.com:5432/postgres?sslmode=require&options=-c%20idle_in_transaction_session_timeout=30s&connectTimeout=10
spring.datasource.username=postgres.dzbeucldelrjdjprfday
spring.datasource.password=${SUPABASE_DB_PASSWORD}
spring.datasource.driver-class-name=org.postgresql.Driver

# ===================================================================
# HIKARI CONNECTION POOL - OPTIMIZADO PARA RAILWAY + SUPABASE
# ===================================================================
# NOTA: Railway env vars con SPRING_DATASOURCE_HIKARI_* NO se aplican autom√°ticamente
# Soluci√≥n: Hardcodear valores directamente aqu√≠

# Maximum Pool Size - HARDCODEADO para evitar problemas de precedencia env vars
# CRITICAL: Supabase Free Tier = 15 conexiones max (Transaction Pooler)
# FORZADO A 2: Railway ignorando variables de entorno SPRING_DATASOURCE_HIKARI_*
spring.datasource.hikari.maximum-pool-size=2

# Minimum Idle - HARDCODEADO para evitar problemas de precedencia env vars
# CRITICAL: Mantener m√≠nimo de conexiones en 1 para ahorrar recursos
spring.datasource.hikari.minimum-idle=1

# Connection Timeout - HARDCODEADO para evitar problemas de precedencia env vars
# Reducido de 30s a 20s para fail-fast en caso de saturaci√≥n
spring.datasource.hikari.connection-timeout=20000

# Idle Timeout (lee de Railway env var o default 10min)
spring.datasource.hikari.idle-timeout=${SPRING_DATASOURCE_HIKARI_IDLE_TIMEOUT:600000}

# Max Lifetime - HARDCODEADO para evitar problemas de precedencia env vars
# Reducido de 30min a 20min para evitar conexiones zombies en Supabase
spring.datasource.hikari.max-lifetime=1200000

# Leak Detection Threshold - HARDCODEADO para evitar problemas de precedencia env vars
# Reducido de 60s a 15s para detectar conexiones no cerradas m√°s r√°pido
spring.datasource.hikari.leak-detection-threshold=15000

# NOTA: pool-name NO se puede configurar (read-only despu√©s de inicializaci√≥n)
# Se usa el nombre por defecto: "HikariPool-1"

# ===================================================================
# FLYWAY - DESHABILITADO EN PRODUCCION
# ===================================================================
# üî¥ CR√çTICO: Flyway deshabilitado
# Raz√≥n: Migraciones YA aplicadas (V7 exitoso)
# Flyway consume 1 conexi√≥n al inicio que no se libera en crash loops
spring.flyway.enabled=false

# ===================================================================
# JPA - CONFIGURACI√ìN OPTIMIZADA PARA PRODUCCI√ìN
# ===================================================================
# üî¥ PRODUCCI√ìN: Deshabilitar show-sql para reducir overhead de logging
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false
spring.jpa.database-platform=org.hibernate.dialect.PostgreSQLDialect

# üî¥ CRITICAL FIX: Deshabilitar cache de segundo nivel Hibernate
# Problema: Railway cachea queries LEFT JOIN previas (cuando variantes=0)
# Soluci√≥n: Forzar queries frescas desde PostgreSQL sin cache
spring.jpa.properties.hibernate.cache.use_second_level_cache=false
spring.jpa.properties.hibernate.cache.use_query_cache=false

# üî¥ CRITICAL FIX: Open Session in View para lazy loading durante JSON serialization
# Railway tiene bug de cache - fetch=EAGER NO se aplica en deployments
# Workaround: Mantener sesi√≥n Hibernate abierta durante renderizado de vista
# Permite lazy loading de variantes/imagenes durante Jackson serialization
spring.jpa.open-in-view=true

# ===================================================================
# LOGGING - OPTIMIZADO PARA RAILWAY
# ===================================================================
logging.level.root=INFO
logging.level.com.milsabores.backend=INFO
logging.level.org.springframework.web=INFO
# üî¥ PRODUCCI√ìN: SQL logging solo en WARN para reducir overhead
logging.level.org.hibernate.SQL=WARN
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=WARN
logging.level.org.hibernate.orm.jdbc.bind=WARN
# üî¥ Debug HikariCP solo al arrancar para diagnosticar pool de conexiones
logging.level.com.zaxxer.hikari=DEBUG
logging.level.org.springframework.jdbc=INFO
logging.level.org.flywaydb=ERROR

# ===================================================================
# ERROR HANDLING
# ===================================================================
server.error.include-message=always
server.error.include-binding-errors=always
server.error.include-stacktrace=never
server.error.include-exception=false

# ===================================================================
# ACTUATOR - HEALTH CHECKS Y M√âTRICAS
# ===================================================================
# Habilitar endpoints de actuator
management.endpoints.web.exposure.include=health,info,metrics,loggers
management.endpoint.health.show-details=always
management.endpoint.health.show-components=always
management.health.defaults.enabled=true

# Custom health indicators
management.health.db.enabled=true
management.health.diskSpace.enabled=true

# ===================================================================
# JWT SECURITY
# ===================================================================
# Configurado via variables de entorno en Railway:
# - JWT_SECRET
# - JWT_EXPIRATION
